\documentclass[a4paper,11pt]{article}

% --- 필수 패키지 ---
\usepackage[margin=1in]{geometry} % 여백 조정
\usepackage{amsmath}    % 수식 환경
\usepackage{amssymb}    % 수학 기호
\usepackage{algorithm}  % 알고리즘 환경
\usepackage{algpseudocode} % 의사코드 작성
\usepackage{bm}         % 진한 수식

% --- 제목 및 저자 설정 (테스트용) ---
\title{Robust Optimization with Endogenous Demand: \\ Exact C\&CG Algorithm Implementation}
\author{Advisor \& Student}
\date{\today}

\begin{document}

\maketitle

\section{Proposed Exact Solution Methodology: C\&CG Algorithm}
\label{sec:ccg_method}

To address the limitations of heuristic approaches and ensure the robustness of the solution, we propose an exact algorithm based on the Column-and-Constraint Generation (C\&CG) framework. Unlike the previous heuristic approach, this method guarantees convergence to the global optimum by iteratively solving a Master Problem (MP) and a Subproblem (SP).

\subsection{Algorithmic Framework}
The proposed robust optimization model aims to maximize the worst-case profit under demand uncertainty. To rigorously capture the risk, we extend the uncertainty set to be \textbf{bidirectional}, allowing demand to fluctuate both upwards (causing shortages) and downwards (causing excess inventory/revenue loss).

The problem is formulated as:
\begin{equation}
    \max_{\mathbf{x}, \mathbf{y}} \left\{ -\text{FixedCosts}(\mathbf{x}, \mathbf{y}) + \min_{\eta \in U(\Gamma)} \max_{\mathbf{z} \in \Omega(\mathbf{x}, \eta)} \text{OpProfit}(\mathbf{z}) \right\}
\end{equation}
where $\mathbf{x}, \mathbf{y}$ represent first-stage strategic decisions (facility location, mode selection), and $\mathbf{z}$ represents second-stage operational decisions.

\subsection{Master Problem (MP)}
The Master Problem relaxes the full uncertainty set and considers only a subset of worst-case scenarios $\mathcal{L} = \{\eta^{(1)}, \dots, \eta^{(L)}\}$ identified iteratively.

\begin{align}
    \textbf{[MP]} \quad Z_{MP} = \max \quad & - \left( \text{OC} + \text{FC} \right) + \vartheta \\
    \text{s.t.} \quad & \textbf{First-Stage Constraints:} \notag \\
    & \text{(Facility capacity, Single sourcing, Mode selection constraints)} \notag \\
    & \text{See Eqs. (8)--(19) in the original model formulation.} \notag \\
    %
    & \textbf{Robust Cuts (for each scenario $l \in \mathcal{L}$):} \notag \\
    & \vartheta \le \sum_{j,r} S \cdot ( \text{Demand}_{rk}^{(l)} - u_{rk}^{(l)} ) - \left( \text{HC}^{(l)} + \text{TC}^{(l)} + \text{PC}^{(l)} + \text{SC}^{(l)} \right), \quad \forall l \in \mathcal{L} \label{eq:mp_cut} \\
    %
    & \textbf{Operational Constraints (for each scenario $l \in \mathcal{L}$):} \notag \\
    & \sum_{j \in J} A_{ij}^{k(l)} \leq MP_{i}, \quad \forall k, i \\
    & \sum_{k \in K} \sum_{i \in I} A_{ij}^{k(l)} \leq MC_{j}, \quad \forall j \\
    & A_{ij}^{k(l)} \leq MC_{j} z_{ij}, \quad \forall k, i, j \\
    & A_{jr}^{k(l)} \leq MC_{j} w_{jr}, \quad \forall j, r \\
    & \sum_{j \in J} A_{jr}^{k(l)} + u_{r}^{k(l)} \ge \underbrace{\sum_{m \in M} \mu_{r}^{k} DI_{mk} \beta_{rm} + \eta_{rk}^{(l)} \hat{\mu}_{r}^{k}}_{\text{Realized Demand}_{rk}^{(l)}}, \quad \forall r, k \label{eq:mp_demand}\\
    & \sum_{i \in I} A_{ij}^{k(l)} = \sum_{r \in R} A_{jr}^{k(l)}, \quad \forall k, j \\
    & A_{ij}^{k(l)}, A_{jr}^{k(l)}, u_{r}^{k(l)} \ge 0
\end{align}
\textbf{Note:} We modified the revenue term in Eq. \eqref{eq:mp_cut} to $S \cdot (\text{Demand} - u)$ to prevent artificial over-supply, and used inequality $\ge$ in Eq. \eqref{eq:mp_demand} to ensure feasibility.

\subsection{Subproblem (SP)}
Given a fixed first-stage solution $(\hat{x}, \hat{y}, \hat{z}, \hat{w}, \hat{\beta}, \hat{\alpha})$, the Subproblem identifies the worst-case demand scenario $\eta$. We define the uncertainty set $U(\Gamma)$ to allow bidirectional deviations to capture both revenue loss (demand decrease) and shortage risk (demand increase).

\begin{equation}
    U(\Gamma) = \left\{ \eta_{rk} \;\middle|\; \eta_{rk} \in \{-1, 0, 1\}, \; \sum_{r} |\eta_{rk}| \le \Gamma_k \right\}
\end{equation}

The SP is reformulated using duality and McCormick linearization. Let $\gamma^L = -SC$ and $\gamma^U = S$ be the bounds for the dual variable $\gamma_{rk}$.

\begin{align}
    \textbf{[SP-Dual]} \quad Z_{SP} = \min_{\eta, \pi, \dots, \xi} \quad & \sum_{k,i} MP_{i} \pi_{ki} + \sum_{j} MC_{j} \sigma_{j} + \sum_{k,i,j} MC_{j} \hat{z}_{ij} \psi_{kij} + \sum_{k,j,r} MC_{j} \hat{w}_{jr} \phi_{kjr} \notag \\
    & + \sum_{r,k} \left( \sum_{m} \mu_{r}^{k} DI_{mk} \hat{\beta}_{rm} \right) \gamma_{rk} + \sum_{r,k} \hat{\mu}_{r}^{k} \xi_{rk} \\
    \text{s.t.} \quad & \pi_{ki} + \sigma_{j} + \psi_{kij} + \kappa_{kj} \ge -h_j/2 - D_{kij}^1 TC^{plant} - F_{ki}, \quad \forall k, i, j \\
    & \phi_{kjr} + \gamma_{rk} - \kappa_{kj} \ge S - \sum_{m} D_{jr}^2 TC_m \hat{\alpha}_{jrm}, \quad \forall k, j, r \\
    & \gamma_{rk} \ge -SC, \quad \forall r, k \\
    & \pi, \sigma, \psi, \phi \ge 0, \quad \gamma, \kappa \in \mathbb{R} \\
    & \textbf{Uncertainty Constraints:} \notag \\
    & \sum_{r} (\eta_{rk}^+ + \eta_{rk}^-) \le \Gamma_k, \quad \forall k \\
    & \eta_{rk} = \eta_{rk}^+ - \eta_{rk}^-, \quad \eta_{rk}^+, \eta_{rk}^- \in \{0, 1\}, \quad \eta_{rk}^+ + \eta_{rk}^- \le 1 \\
    & \textbf{McCormick Linearization for } \xi_{rk} = \eta_{rk} \gamma_{rk}: \notag \\
    & \xi_{rk} \ge \gamma^L \eta_{rk}^+ - \gamma^U \eta_{rk}^- \label{eq:mc_new1} \\ 
    & \xi_{rk} \le \gamma^U \eta_{rk}^+ - \gamma^L \eta_{rk}^- \label{eq:mc_new2} \\
    & \xi_{rk} \ge \gamma_{rk} - \gamma^U (1 - \eta_{rk}^+) + \gamma^L (1 - \eta_{rk}^-) \label{eq:mc_new3} \\
    & \xi_{rk} \le \gamma_{rk} - \gamma^L (1 - \eta_{rk}^+) + \gamma^U (1 - \eta_{rk}^-) \label{eq:mc_new4}
\end{align}
Here, we decompose $\eta_{rk}$ into positive ($\eta^+$) and negative ($\eta^-$) binary components to handle the bidirectional uncertainty within the MILP framework.

\subsection{Algorithm}
The C\&CG procedure iterates between [MP] and [SP-Dual] until the gap $(UB - LB)$ falls below a tolerance $\epsilon$. In each iteration, the worst-case scenario $\eta^*$ from SP is added to $\mathcal{L}$, tightening the robust approximation in MP.

\begin{algorithm}
\caption{Column-and-Constraint Generation (C\&CG) for Robust Logistics Design}
\label{alg:ccg}
\begin{algorithmic}[1]
\State \textbf{Initialize:} Set $LB = -\infty$, $UB = +\infty$, tolerance $\epsilon = 10^{-4}$.
\State Set iteration counter $iter = 0$ and scenario set $\mathcal{L} = \emptyset$.
\State \textbf{Initial Scenario:} Add nominal demand scenario $\eta^{(0)} = \mathbf{0}$ to $\mathcal{L}$.
\While{$(UB - LB) > \epsilon$}
    \State $iter \leftarrow iter + 1$
    \State \textbf{Step 1: Master Problem}
    \State Solve \textbf{[MP]} with current $\mathcal{L}$.
    \State Get optimal first-stage solution $(\hat{x}, \hat{y}, \hat{z}, \hat{w}, \hat{\beta}, \hat{\alpha})$ and objective value $Z_{MP}^*$.
    \State Update $UB = Z_{MP}^*$.
    
    \State \textbf{Step 2: Subproblem}
    \State Solve \textbf{[SP-Dual]} using fixed first-stage variables.
    \State Get worst-case scenario $\eta^*$ (composed of $\eta^{+*}, \eta^{-*}$) and objective value $Z_{SP}^*$.
    \State Calculate true profit: $Z_{True} = -(\text{Fixed Costs}) + Z_{SP}^*$.
    \State Update $LB = \max(LB, Z_{True})$.
    
    \State \textbf{Step 3: Convergence Check}
    \If{$(UB - LB) \le \epsilon$}
        \State \textbf{Break}
    \Else
        \State Add identified worst-case scenario $\eta^*$ to $\mathcal{L}$.
        \State Add associated second-stage variables and constraints to [MP].
    \EndIf
\EndWhile
\State \textbf{Return} optimal robust solution $(\hat{x}, \hat{y}, \hat{z}, \hat{w}, \hat{\beta})$.
\end{algorithmic}
\end{algorithm}

% --- 참고문헌 (수동 입력) ---
\begin{thebibliography}{9}
\bibitem{zeng2013solving}
Zeng, B., \& Zhao, L. (2013). Solving two-stage robust optimization problems using a column-and-constraint generation method. \textit{Operations Research Letters}, 41(5), 457-461.
\end{thebibliography}

\end{document}