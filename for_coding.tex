\documentclass[a4paper,11pt]{article}

% --- Essential Packages ---
\usepackage[margin=1in]{geometry}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{bm}
\usepackage{booktabs}
\usepackage{setspace}
\usepackage[utf8]{inputenc}

% --- Settings ---
\onehalfspacing
\allowdisplaybreaks

\title{\textbf{Implementation Guide: \\ Two-Stage Robust Optimization with C\&CG Algorithm}}
\author{}
\date{\today}

\begin{document}

\maketitle

\section{Problem Overview}
\label{sec:overview}

Three-echelon supply chain design with:
\begin{itemize}
    \item Strategic decisions (first-stage): facility location, mode selection
    \item Operational decisions (second-stage): production, flow distribution
    \item Bidirectional demand uncertainty: both surges (shortage risk) and drops (revenue loss)
    \item Solution method: Column-and-Constraint Generation (C\&CG) algorithm
\end{itemize}

\section{Input Data Structure}
\label{sec:input_data}

\subsection{Sets and Indices}
\begin{itemize}
    \item $K$: Set of products (index $k$)
    \item $I$: Set of candidate plants (index $i$)
    \item $J$: Set of candidate distribution centers (DCs) (index $j$)
    \item $R$: Set of customers (index $r$)
    \item $M$: Set of transportation modes (index $m$)
\end{itemize}

\subsection{Parameters}
\begin{itemize}
    \item $S$: Unit selling price
    \item $SC$: Unit shortage cost
    \item $MP_{ki}$: Maximum production capacity of plant $i$ for product $k$
    \item $MC_{j}$: Maximum throughput capacity of DC $j$
    \item $\mu_{rk}$: Nominal demand of customer $r$ for product $k$
    \item $\hat{\mu}_{rk}$: Maximum demand deviation for customer $r$ and product $k$
    \item $\Gamma_k$: Budget of uncertainty for product $k$
    \item $DI_{mk}$: Demand increase factor for mode $m$ and product $k$
    \item $C_{ki}^{plant}$: Fixed cost of opening plant $i$ for product $k$
    \item $C_{j}^{dc}$: Fixed cost of opening DC $j$
    \item $O_j$: Ordering cost at DC $j$
    \item $L_{kij}^1$: Fixed cost of establishing route from plant $i$ to DC $j$ for product $k$
    \item $L_{jr}^2$: Fixed cost of establishing route from DC $j$ to customer $r$
    \item $F_{ki}$: Unit production cost at plant $i$ for product $k$
    \item $h_j$: Unit holding cost at DC $j$
    \item $t$: Unit transportation cost (plant to DC)
    \item $TC_m$: Unit transportation cost coefficient for mode $m$ (DC to customer)
    \item $D_{kij}^1$: Distance from plant $i$ to DC $j$ for product $k$
    \item $D_{jr}^2$: Distance from DC $j$ to customer $r$
\end{itemize}

\section{Mathematical Formulation}
\label{sec:formulation}

\subsection{Decision Variables}

\subsubsection{First-Stage Variables}
\begin{itemize}
    \item $x_i \in \{0,1\}$: 1 if plant $i$ is opened
    \item $y_j \in \{0,1\}$: 1 if DC $j$ is opened
    \item $z_{ij} \in \{0,1\}$: 1 if DC $j$ is supplied by plant $i$
    \item $w_{jr} \in \{0,1\}$: 1 if customer $r$ is served by DC $j$
    \item $\beta_{rm} \in \{0,1\}$: 1 if customer $r$ is served using mode $m$
    \item $\alpha_{jrm} \in \{0,1\}$: 1 if mode $m$ is used from DC $j$ to customer $r$
\end{itemize}

\subsubsection{Second-Stage Variables (per scenario $l$)}
\begin{itemize}
    \item $A_{ij}^{k(l)} \ge 0$: Quantity of product $k$ from plant $i$ to DC $j$ in scenario $l$
    \item $A_{jr}^{k(l)} \ge 0$: Quantity of product $k$ from DC $j$ to customer $r$ in scenario $l$
    \item $u_{rk}^{(l)} \ge 0$: Shortage quantity of product $k$ for customer $r$ in scenario $l$
\end{itemize}

\subsection{Uncertainty Modeling}

\subsubsection{Realized Demand}
\begin{equation}
    \tilde{d}_{rk} = \sum_{m \in M} \mu_{rk} DI_{mk} \beta_{rm} + \eta_{rk} \hat{\mu}_{rk}
\end{equation}

\subsubsection{Uncertainty Set}
\begin{equation}
    U(\Gamma) = \left\{ \bm{\eta} \in \mathbb{R}^{|R| \times |K|} \;\middle|\; \eta_{rk} \in [-1, 1], \; \sum_{r \in R} |\eta_{rk}| \le \Gamma_k, \; \forall k \in K \right\}
\end{equation}

\subsubsection{Binary Decomposition for Linearization}
\begin{align}
    \eta_{rk} &= \eta_{rk}^+ - \eta_{rk}^- \\
    \eta_{rk}^+, \eta_{rk}^- &\in \{0, 1\} \\
    \eta_{rk}^+ + \eta_{rk}^- &\le 1 \\
    \sum_{r \in R} \left(\eta_{rk}^+ + \eta_{rk}^-\right) &\le \Gamma_k, \quad \forall k \in K
\end{align}

Realized demand for scenario $l$:
\begin{equation}
    \tilde{d}_{rk}^{(l)} = \sum_{m \in M} \mu_{rk} DI_{mk} \beta_{rm} + \left(\eta_{rk}^{+(l)} - \eta_{rk}^{-(l)}\right) \hat{\mu}_{rk}
\end{equation}

\subsection{Cost Components}

\subsubsection{Strategic Costs}
\begin{align}
    \text{OC}(\mathbf{y}) &= \sum_{j \in J} O_j y_j \\
    \text{FC}(\mathbf{x}, \mathbf{y}, \mathbf{z}, \mathbf{w}) &= \sum_{k \in K} \sum_{i \in I} C_{ki}^{plant} x_i + \sum_{j \in J} C_{j}^{dc} y_j \notag \\
    &\quad + \sum_{k \in K} \sum_{i \in I} \sum_{j \in J} L_{kij}^1 z_{ij} + \sum_{j \in J} \sum_{r \in R} L_{jr}^2 w_{jr}
\end{align}

\subsubsection{Operational Costs (per scenario)}
\begin{align}
    \text{HC}(\mathbf{A}) &= \sum_{k \in K} \sum_{i \in I} \sum_{j \in J} \frac{h_j}{2} A_{ij}^k \\
    \text{TC}(\mathbf{A}, \bm{\alpha}) &= \sum_{k \in K} \sum_{i \in I} \sum_{j \in J} D_{kij}^1 t A_{ij}^k + \sum_{k \in K} \sum_{j \in J} \sum_{r \in R} \sum_{m \in M} D_{jr}^2 TC_m \alpha_{jrm} A_{jr}^k \\
    \text{PC}(\mathbf{A}) &= \sum_{k \in K} \sum_{i \in I} \sum_{j \in J} F_{ki} A_{ij}^k \\
    \text{SC}(\mathbf{u}) &= \sum_{r \in R} \sum_{k \in K} SC u_{rk}
\end{align}

\subsubsection{Revenue (CRITICAL)}
\begin{equation}
    \text{Revenue}(\mathbf{u}, \bm{\eta}) = \sum_{r \in R} \sum_{k \in K} S \cdot \left(\tilde{d}_{rk}(\bm{\eta}) - u_{rk}\right)
\end{equation}

Revenue is based on actual sales, not shipped quantity.

\section{C\&CG Algorithm Implementation}
\label{sec:ccg_implementation}

\subsection{Master Problem (MP)}

\textbf{Objective:}
\begin{equation}
    \max \quad -\text{OC}(\mathbf{y}) - \text{FC}(\mathbf{x}, \mathbf{y}, \mathbf{z}, \mathbf{w}) + \vartheta
\end{equation}

\textbf{Constraints:}

\paragraph{Network Topology:}
\begin{align}
    \sum_{j \in J} w_{jr} &= 1, \quad \forall r \in R \\
    \sum_{m \in M} \alpha_{jrm} &= w_{jr}, \quad \forall j \in J, r \in R \\
    \sum_{j \in J} \alpha_{jrm} &= \beta_{rm}, \quad \forall r \in R, m \in M \\
    z_{ij} &\le x_i, \quad \forall i \in I, j \in J \\
    z_{ij} &\le y_j, \quad \forall i \in I, j \in J \\
    w_{jr} &\le y_j, \quad \forall j \in J, r \in R \\
    x_i, y_j, z_{ij}, w_{jr}, \alpha_{jrm}, \beta_{rm} &\in \{0, 1\}
\end{align}

\paragraph{For each scenario $l \in \mathcal{L}$:}

Operational constraints:
\begin{align}
    \sum_{j \in J} A_{ij}^{k(l)} &\le MP_{ki}, \quad \forall k \in K, i \in I \\
    \sum_{k \in K} \sum_{i \in I} A_{ij}^{k(l)} &\le MC_j, \quad \forall j \in J \\
    A_{ij}^{k(l)} &\le MC_j z_{ij}, \quad \forall k \in K, i \in I, j \in J \\
    A_{jr}^{k(l)} &\le MC_j w_{jr}, \quad \forall k \in K, j \in J, r \in R \\
    \sum_{j \in J} A_{jr}^{k(l)} + u_{rk}^{(l)} &= \tilde{d}_{rk}^{(l)}, \quad \forall k \in K, r \in R \\
    \sum_{i \in I} A_{ij}^{k(l)} &= \sum_{r \in R} A_{jr}^{k(l)}, \quad \forall k \in K, j \in J \\
    A_{ij}^{k(l)}, A_{jr}^{k(l)}, u_{rk}^{(l)} &\ge 0
\end{align}

Optimality cut (with linearized transportation cost):
\begin{align}
    \vartheta &\le \sum_{k \in K} \sum_{r \in R} S \cdot \left(\tilde{d}_{rk}^{(l)} - u_{rk}^{(l)}\right) - \text{HC}^{(l)} - \text{PC}^{(l)} - \text{SC}^{(l)} \notag \\
    &\quad - \left(\sum_{k}\sum_{i}\sum_{j} D_{kij}^{1} t A_{ij}^{k(l)} + \sum_{k}\sum_{j}\sum_{r}\sum_{m} D_{jr}^{2} TC_{m} X_{jrm}^{k(l)}\right)
\end{align}

\paragraph{Linearization of bilinear terms $\alpha_{jrm} \cdot A_{jr}^{k(l)}$:}
Introduce auxiliary variables $X_{jrm}^{k(l)}$ with constraints:
\begin{align}
    X_{jrm}^{k(l)} &\le MC_j \cdot \alpha_{jrm}, \quad \forall k, j, r, m, l \\
    X_{jrm}^{k(l)} &\le A_{jr}^{k(l)}, \quad \forall k, j, r, m, l \\
    X_{jrm}^{k(l)} &\ge A_{jr}^{k(l)} - MC_j (1 - \alpha_{jrm}), \quad \forall k, j, r, m, l \\
    X_{jrm}^{k(l)} &\ge 0, \quad \forall k, j, r, m, l
\end{align}

Big-M value: $M_j = MC_j$ (DC capacity is the tight bound)

\subsection{Subproblem (SP)}

\textbf{Goal:} Find worst-case scenario given fixed first-stage solution $(\hat{\mathbf{x}}, \hat{\mathbf{y}}, \hat{\mathbf{z}}, \hat{\mathbf{w}}, \hat{\bm{\beta}}, \hat{\bm{\alpha}})$

\textbf{Dual Variables:}
\begin{itemize}
    \item $\pi_{ki} \ge 0$: Dual for plant capacity
    \item $\sigma_j \ge 0$: Dual for DC capacity
    \item $\psi_{kij} \ge 0$: Dual for plant-DC route
    \item $\phi_{kjr} \ge 0$: Dual for DC-customer route
    \item $\gamma_{rk} \in \mathbb{R}$: Dual for demand satisfaction
    \item $\kappa_{kj} \in \mathbb{R}$: Dual for flow balance
\end{itemize}

\textbf{Objective:}
\begin{align}
    \min \quad & \sum_{k \in K} \sum_{i \in I} MP_{ki} \pi_{ki} + \sum_{j \in J} MC_j \sigma_j + \sum_{k \in K} \sum_{i \in I} \sum_{j \in J} MC_j \hat{z}_{ij} \psi_{kij} \notag \\
    & + \sum_{k \in K} \sum_{j \in J} \sum_{r \in R} MC_j \hat{w}_{jr} \phi_{kjr} + \sum_{r \in R} \sum_{k \in K} \left(\sum_{m \in M} \mu_{rk} DI_{mk} \hat{\beta}_{rm}\right) \gamma_{rk} \notag \\
    & + \sum_{r \in R} \sum_{k \in K} \hat{\mu}_{rk} \xi_{rk}
\end{align}

\textbf{Constraints:}

Dual feasibility:
\begin{align}
    \pi_{ki} + \sigma_j + \psi_{kij} + \kappa_{kj} &\ge -\frac{h_j}{2} - D_{kij}^1 t - F_{ki}, \quad \forall k, i, j \\
    \phi_{kjr} + \gamma_{rk} - \kappa_{kj} &\ge - \sum_{m \in M} D_{jr}^2 TC_m \hat{\alpha}_{jrm}, \quad \forall k, j, r \\
    \gamma_{rk} &\ge -(S+SC), \quad \forall r, k \\
    \pi_{ki}, \sigma_j, \psi_{kij}, \phi_{kjr} &\ge 0, \quad \gamma_{rk}, \kappa_{kj} \in \mathbb{R}
\end{align}

Uncertainty set:
\begin{align}
    \sum_{r \in R} \left(\eta_{rk}^+ + \eta_{rk}^-\right) &\le \Gamma_k, \quad \forall k \in K \\
    \eta_{rk}^+, \eta_{rk}^- &\in \{0, 1\}, \quad \forall r, k \\
    \eta_{rk}^+ + \eta_{rk}^- &\le 1, \quad \forall r, k
\end{align}

\paragraph{McCormick Linearization:}

Decompose $\xi_{rk} = \left(\eta_{rk}^+ - \eta_{rk}^-\right) \gamma_{rk}$ as:
\begin{equation}
    \xi_{rk} = p_{rk}^+ - p_{rk}^-
\end{equation}

Bounds for $\gamma_{rk}$:
\begin{align}
    \gamma^L &= -(S + SC) \\
    \gamma^U &= S
\end{align}

For $p_{rk}^+ = \eta_{rk}^+ \gamma_{rk}$:
\begin{align}
    p_{rk}^+ &\ge \gamma^L \eta_{rk}^+ \\
    p_{rk}^+ &\le \gamma^U \eta_{rk}^+ \\
    p_{rk}^+ &\ge \gamma_{rk} - \gamma^U (1 - \eta_{rk}^+) \\
    p_{rk}^+ &\le \gamma_{rk} - \gamma^L (1 - \eta_{rk}^+)
\end{align}

For $p_{rk}^- = \eta_{rk}^- \gamma_{rk}$:
\begin{align}
    p_{rk}^- &\ge \gamma^L \eta_{rk}^- \\
    p_{rk}^- &\le \gamma^U \eta_{rk}^- \\
    p_{rk}^- &\ge \gamma_{rk} - \gamma^U (1 - \eta_{rk}^-) \\
    p_{rk}^- &\le \gamma_{rk} - \gamma^L (1 - \eta_{rk}^-)
\end{align}

\subsection{Algorithm Procedure}

\begin{algorithm}[H]
\caption{Column-and-Constraint Generation (C\&CG)}
\begin{algorithmic}[1]
\State \textbf{Initialize:}
    \State $LB = -\infty$, $UB = +\infty$
    \State $\epsilon = 10^{-4}$ (convergence tolerance)
    \State $\mathcal{L} = \{\mathbf{0}\}$ (start with nominal scenario)
    \State $iter = 0$

\While{$(UB - LB) > \epsilon$}
    \State $iter \leftarrow iter + 1$
    
    \State \textbf{Step 1: Solve Master Problem}
    \State Solve MP with all scenarios in $\mathcal{L}$
    \State Get: $(\hat{\mathbf{x}}, \hat{\mathbf{y}}, \hat{\mathbf{z}}, \hat{\mathbf{w}}, \hat{\bm{\beta}}, \hat{\bm{\alpha}})$, $\{\mathbf{A}^{(l)}, \mathbf{u}^{(l)}\}_{l \in \mathcal{L}}$, $\vartheta^*$
    \State Update: $UB = -\text{OC}(\hat{\mathbf{y}}) - \text{FC}(\hat{\mathbf{x}}, \hat{\mathbf{y}}, \hat{\mathbf{z}}, \hat{\mathbf{w}}) + \vartheta^*$
    
    \State \textbf{Step 2: Solve Subproblem}
    \State Fix first-stage variables to $(\hat{\mathbf{x}}, \hat{\mathbf{y}}, \hat{\mathbf{z}}, \hat{\mathbf{w}}, \hat{\bm{\beta}}, \hat{\bm{\alpha}})$
    \State Solve SP to get: $\bm{\eta}^{*(iter)} = \{\eta_{rk}^{+*}, \eta_{rk}^{-*}\}_{r,k}$, $Z_{SP}^*$
    \State Calculate: $Z_{Current} = -\text{OC}(\hat{\mathbf{y}}) - \text{FC}(\hat{\mathbf{x}}, \hat{\mathbf{y}}, \hat{\mathbf{z}}, \hat{\mathbf{w}}) + Z_{SP}^*$
    \State Update: $LB = \max(LB, Z_{Current})$
    
    \State \textbf{Step 3: Convergence Check}
    \If{$(UB - LB) \le \epsilon$}
        \State \textbf{Terminate} (optimal solution found)
    \Else
        \State Add scenario: $\mathcal{L} \leftarrow \mathcal{L} \cup \{\bm{\eta}^{*(iter)}\}$
        \State Add to MP:
        \State \quad - New second-stage variables: $A_{ij}^{k(iter)}, A_{jr}^{k(iter)}, u_{rk}^{(iter)}$
        \State \quad - New operational constraints for scenario $iter$
        \State \quad - New optimality cut for scenario $iter$
        \State \quad - New linearization variables: $X_{jrm}^{k(iter)}$
    \EndIf
\EndWhile

\State \textbf{Output:}
\State \quad - Optimal solution: $(\hat{\mathbf{x}}^*, \hat{\mathbf{y}}^*, \hat{\mathbf{z}}^*, \hat{\mathbf{w}}^*, \hat{\bm{\beta}}^*, \hat{\bm{\alpha}}^*)$
\State \quad - Robust objective: $Z^* = LB$
\State \quad - Critical scenarios: $\mathcal{L}$
\end{algorithmic}
\end{algorithm}

\section{Implementation Notes}
\label{sec:implementation}

\subsection{Data Structures}

\textbf{Input data:}
\begin{itemize}
    \item Sets: $K, I, J, R, M$ (store as lists or arrays)
    \item Parameters: Store as dictionaries/matrices indexed by appropriate keys
    \item Example: \texttt{MP[k][i]}, \texttt{MC[j]}, \texttt{mu[r][k]}, etc.
\end{itemize}

\textbf{Variables:}
\begin{itemize}
    \item First-stage: Single set of binary variables (do not change across iterations)
    \item Second-stage: Create new set for each scenario $l \in \mathcal{L}$
    \item Naming convention: \texttt{A\_ij[k][i][j][l]}, \texttt{A\_jr[k][j][r][l]}, \texttt{u[r][k][l]}
\end{itemize}

\subsection{Solver Setup}

\textbf{Recommended solvers:}
\begin{itemize}
    \item Gurobi (best performance)
    \item CPLEX (good alternative)
    \item SCIP (open-source option)
\end{itemize}

\textbf{Solver parameters:}
\begin{itemize}
    \item Set MIP gap tolerance: $10^{-4}$ for both MP and SP
    \item Enable presolve
    \item Set time limit per iteration if needed
    \item Log file for debugging
\end{itemize}

\subsection{Algorithm Initialization}

\textbf{Step 1: Initialize scenario set}
\begin{itemize}
    \item Start with nominal scenario: $\eta_{rk}^{+(0)} = 0$, $\eta_{rk}^{-(0)} = 0$ for all $r, k$
    \item Calculate nominal demand: $\tilde{d}_{rk}^{(0)} = \sum_{m} \mu_{rk} DI_{mk} \beta_{rm}$
\end{itemize}

\textbf{Step 2: Build initial MP}
\begin{itemize}
    \item Add all first-stage variables and constraints
    \item Add second-stage variables for scenario 0
    \item Add operational constraints for scenario 0
    \item Add optimality cut for scenario 0
\end{itemize}

\subsection{Iteration Loop}

\textbf{Solving MP:}
\begin{itemize}
    \item Extract first-stage solution: $\hat{x}_i, \hat{y}_j, \hat{z}_{ij}, \hat{w}_{jr}, \hat{\beta}_{rm}, \hat{\alpha}_{jrm}$
    \item Extract second-stage solutions for all $l \in \mathcal{L}$
    \item Extract $\vartheta^*$ value
    \item Calculate UB
\end{itemize}

\textbf{Solving SP:}
\begin{itemize}
    \item Fix first-stage variables using solver parameters or by setting bounds
    \item Solve to optimality
    \item Extract: $\eta_{rk}^{+*}, \eta_{rk}^{-*}$ for all $r, k$
    \item Extract dual objective value $Z_{SP}^*$
    \item Calculate LB
\end{itemize}

\textbf{Adding new scenario:}
\begin{itemize}
    \item Store new scenario: $\mathcal{L} \leftarrow \mathcal{L} \cup \{\bm{\eta}^{*(iter)}\}$
    \item Calculate realized demand: $\tilde{d}_{rk}^{(iter)} = \sum_{m} \mu_{rk} DI_{mk} \hat{\beta}_{rm} + (\eta_{rk}^{+*} - \eta_{rk}^{-*}) \hat{\mu}_{rk}$
    \item Add to MP:
    \begin{itemize}
        \item New second-stage variables: $A_{ij}^{k(iter)}, A_{jr}^{k(iter)}, u_{rk}^{(iter)}$
        \item New linearization variables: $X_{jrm}^{k(iter)}$
        \item New operational constraints (plant capacity, DC capacity, routes, demand, balance)
        \item New optimality cut with calculated $\tilde{d}_{rk}^{(iter)}$
        \item New linearization constraints for $X_{jrm}^{k(iter)}$
    \end{itemize}
\end{itemize}

\subsection{Termination}

\textbf{Convergence check:}
\begin{itemize}
    \item Calculate gap: $gap = UB - LB$
    \item If $gap \le \epsilon = 10^{-4}$: terminate
    \item Relative gap (optional): $gap_{rel} = \frac{|UB - LB|}{|LB| + 10^{-10}}$
\end{itemize}

\textbf{Output:}
\begin{itemize}
    \item Optimal first-stage decisions
    \item Robust objective value: $Z^* = LB$
    \item Number of scenarios: $|\mathcal{L}|$
    \item Number of iterations
    \item Computation time
    \item Gap evolution (for plotting)
\end{itemize}

\subsection{Debugging Tips}

\begin{itemize}
    \item Check infeasibility: If MP or SP is infeasible, check constraint formulation
    \item Monitor bounds: Both LB and UB should converge; if not, check cut generation
    \item Verify demand calculation: Print $\tilde{d}_{rk}^{(l)}$ for each scenario
    \item Check scenario uniqueness: Ensure no duplicate scenarios are added
    \item Log solver status: Check if problems are solved to optimality
    \item Small instance test: Start with small problem (e.g., $|K|=1, |I|=2, |J|=2, |R|=3, |M|=2$)
\end{itemize}

\section{Problem Size Estimates}
\label{sec:size}

For baseline instance ($|K|=3, |I|=5, |J|=20, |R|=100, |M|=3$):

\textbf{Variables:}
\begin{itemize}
    \item First-stage binary: $\approx 6,000$
    \item Second-stage continuous (per scenario): $\approx 6,300$
    \item Linearization variables (per scenario): $|K| \times |J| \times |R| \times |M| = 18,000$
    \item Total at convergence with $L$ scenarios: $6,000 + (6,300 + 18,000) \times L$
\end{itemize}

\textbf{Constraints:}
\begin{itemize}
    \item First-stage: $\approx 500$
    \item Per scenario: $\approx 10,000$
    \item Total with $L$ scenarios: $500 + 10,000 \times L$
\end{itemize}

\textbf{Expected convergence:}
\begin{itemize}
    \item Typical: $L \le 50$ scenarios
    \item Worst case: $L \approx 100-200$ scenarios
\end{itemize}

\end{document}